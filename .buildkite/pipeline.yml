steps:
  - label: ":package: Install dependencies"
    commands:
      - "bash deploy/ci-run.sh install"
    key: install
    agents:
      queue: "connectors-stg-ap-southeast-2"

  - label: ":mag: Lint"
    commands:
      - "bash deploy/ci-run.sh lint"
    depends_on: install
    key: lint
    agents:
      queue: "nextgen-deploy-m4udev"

  - label: ":hammer: Build"
    commands:
      - "bash deploy/ci-run.sh build"
    depends_on: lint
    key: build
    agents:
      queue: "nextgen-deploy-m4udev"

  - label: ":test_tube: Test"
    commands:
      - "bash deploy/ci-run.sh test"
    depends_on: build
    key: test
    agents:
      queue: "nextgen-deploy-m4udev"

  - wait

  - block: "Manual approval required to deploy release"
    if: build.branch == "main"
    depends_on: test
    key: release-approval

  - label: ":rocket: Release (main only)"
    if: build.branch == "main"
    depends_on: release-approval
    key: release
    commands:
      - "bash deploy/ci-run.sh release"
    agents:
      queue: "nextgen-deploy-m4udev"
